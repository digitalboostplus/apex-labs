rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {

        // ====================================================================
        // Helper Functions
        // ====================================================================

        function isAuthenticated() {
            return request.auth != null;
        }

        function isOwner(userId) {
            return isAuthenticated() && request.auth.uid == userId;
        }

        function isAdmin() {
            return isAuthenticated() &&
                   exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
                   get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin';
        }

        // Validation functions
        function isValidEmail(email) {
            return email is string &&
                   email.size() >= 3 &&
                   email.size() <= 254 &&
                   email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$');
        }

        function isValidDisplayName(name) {
            return name == null || (
                name is string &&
                name.size() > 0 &&
                name.size() <= 100
            );
        }

        function isValidPhotoURL(url) {
            return url == null || (
                url is string &&
                url.size() >= 10 &&
                url.size() <= 2048 &&
                url.matches('^https?://')
            );
        }

        function isValidPhoneNumber(phone) {
            return phone == null || (
                phone is string &&
                phone.matches('^\\+[1-9]\\d{1,14}$')
            );
        }

        // ====================================================================
        // Users Collection - Enhanced with field validation
        // ====================================================================

        match /users/{userId} {
            // READ: Users can read own profile, admins can read any
            allow read: if isOwner(userId) || isAdmin();

            // CREATE: New user profile on signup
            allow create: if isOwner(userId) &&
                // Required fields
                isValidEmail(request.resource.data.email) &&
                request.resource.data.email == request.auth.token.email &&
                request.resource.data.createdAt == request.time &&
                request.resource.data.updatedAt == request.time &&
                // Optional fields
                isValidDisplayName(request.resource.data.get('displayName', null)) &&
                isValidPhotoURL(request.resource.data.get('photoURL', null)) &&
                isValidPhoneNumber(request.resource.data.get('phoneNumber', null));

            // UPDATE: Users can update their profile
            allow update: if isOwner(userId) &&
                // Immutable fields cannot change
                request.resource.data.email == resource.data.email &&
                request.resource.data.createdAt == resource.data.createdAt &&
                // Auto-update timestamp
                request.resource.data.updatedAt == request.time &&
                // Validate editable fields
                isValidDisplayName(request.resource.data.get('displayName', null)) &&
                isValidPhotoURL(request.resource.data.get('photoURL', null)) &&
                isValidPhoneNumber(request.resource.data.get('phoneNumber', null));

            // User's orders subcollection
            match /orders/{orderId} {
                allow read: if isOwner(userId);
                // Only Cloud Functions can write to orders
                allow write: if false;
            }

            // User's addresses subcollection
            match /addresses/{addressId} {
                allow read, write: if isOwner(userId);
            }

            // User's wishlist subcollection
            match /wishlist/{productId} {
                allow read, write: if isOwner(userId);
            }
        }

        // Orders collection (main)
        match /orders/{orderId} {
            // Users can read their own orders
            allow read: if isAuthenticated() &&
                        resource.data.userId == request.auth.uid;
            // Only Cloud Functions can create/update orders
            allow write: if false;
        }

        // Products collection (if we migrate from JSON)
        match /products/{productId} {
            // Anyone can read products
            allow read: if true;
            // Only admins can write products
            allow write: if isAdmin();
        }

        // Reviews collection
        match /reviews/{reviewId} {
            // Anyone can read reviews
            allow read: if true;
            // Only authenticated users can create reviews
            allow create: if isAuthenticated() &&
                          request.resource.data.userId == request.auth.uid;
            // Users can only update/delete their own reviews
            allow update, delete: if isOwner(resource.data.userId);
        }

        // Admins collection
        match /admins/{userId} {
            // Only admins can read/write admin collection
            allow read, write: if isAdmin();
        }

        // Analytics/events collection (write-only for tracking)
        match /events/{eventId} {
            allow create: if true;
            allow read, update, delete: if isAdmin();
        }

        // Wholesale Inquiries collection
        match /wholesaleInquiries/{inquiryId} {
            // Anyone can create wholesale inquiries
            allow create: if request.resource.data.name is string &&
                          request.resource.data.name.size() > 0 &&
                          request.resource.data.name.size() <= 100 &&
                          isValidEmail(request.resource.data.email) &&
                          request.resource.data.phone is string &&
                          request.resource.data.phone.size() > 0 &&
                          request.resource.data.company is string &&
                          request.resource.data.company.size() > 0 &&
                          request.resource.data.volume is string &&
                          request.resource.data.status == 'new' &&
                          request.resource.data.createdAt == request.time;

            // Only admins can read/update/delete inquiries
            allow read, update, delete: if isAdmin();
        }
    }
}
