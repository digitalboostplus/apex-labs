<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-141458J082"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-141458J082');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Addresses | Apex Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../css/design-system.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../../js/cart.js" defer></script>
    <script src="../../js/firebase-init.js" defer></script>
    <script src="../../js/auth.js" defer></script>
</head>

<body class="bg-gray-50 antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-100 sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <a href="../../index.html" class="flex items-center gap-2">
                    <span class="text-xl font-black text-slate-900 tracking-tight">APEX LABS</span>
                </a>
                <div class="flex items-center gap-4">
                    <a href="../../peptides.html"
                        class="text-sm font-medium text-slate-600 hover:text-slate-900">Shop</a>
                    <button onclick="toggleCart()"
                        class="relative p-2 hover:bg-slate-100 rounded-lg transition-colors cursor-pointer">
                        <i data-lucide="shopping-bag" class="w-5 h-5 text-slate-600"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-6 py-12">
        <div class="grid lg:grid-cols-12 gap-8">
            <!-- Sidebar -->
            <aside class="lg:col-span-3">
                <div class="bg-white rounded-xl border border-slate-100 p-6 sticky top-24">
                    <div class="flex items-center gap-4 mb-6 pb-6 border-b border-slate-100">
                        <div id="sidebar-avatar"
                            class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center text-white font-bold text-lg">
                        </div>
                        <div>
                            <p id="sidebar-name" class="font-bold text-slate-900">Loading...</p>
                            <p id="sidebar-email" class="text-sm text-slate-500 truncate max-w-[150px]"></p>
                        </div>
                    </div>

                    <nav class="space-y-1">
                        <a href="index.html"
                            class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
                            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                            Dashboard
                        </a>
                        <a href="orders.html"
                            class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
                            <i data-lucide="package" class="w-5 h-5"></i>
                            Orders
                        </a>
                        <a href="wishlist.html"
                            class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
                            <i data-lucide="heart" class="w-5 h-5"></i>
                            Wishlist
                        </a>
                        <a href="addresses.html"
                            class="flex items-center gap-3 px-4 py-3 rounded-lg bg-amber-50 text-amber-700 font-medium">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            Addresses
                        </a>
                    </nav>

                    <button onclick="handleSignOut()"
                        class="w-full mt-6 pt-6 border-t border-slate-100 flex items-center gap-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors cursor-pointer">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        Sign Out
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="lg:col-span-9">
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900">Saved Addresses</h1>
                        <p class="text-slate-500 mt-1">Manage your shipping addresses.</p>
                    </div>
                    <button onclick="showAddressModal()"
                        class="px-4 py-2 bg-amber-600 text-white font-bold rounded-lg hover:bg-amber-700 transition-colors cursor-pointer text-sm flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Add Address
                    </button>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="text-center py-12">
                    <div
                        class="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto">
                    </div>
                    <p class="text-slate-500 mt-4">Loading addresses...</p>
                </div>

                <!-- Addresses Grid -->
                <div id="addresses-grid" class="hidden grid sm:grid-cols-2 gap-6">
                    <!-- Addresses will be inserted here -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-16 bg-white rounded-xl border border-slate-100">
                    <i data-lucide="map-pin" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
                    <h2 class="text-xl font-bold text-slate-900 mb-2">No saved addresses</h2>
                    <p class="text-slate-500 mb-6">Add an address for faster checkout.</p>
                    <button onclick="showAddressModal()"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-amber-600 text-white font-bold rounded-xl hover:bg-amber-700 transition-colors cursor-pointer">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        Add Address
                    </button>
                </div>
            </main>
        </div>
    </div>

    <!-- Address Modal -->
    <div id="address-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/40 backdrop-blur-sm" onclick="hideAddressModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg pointer-events-auto">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h2 id="modal-title" class="text-xl font-bold text-slate-900">Add Address</h2>
                    <button onclick="hideAddressModal()" class="p-2 hover:bg-slate-100 rounded-full cursor-pointer">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <form id="address-form" class="p-6 space-y-4">
                    <input type="hidden" id="address-id">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">First Name</label>
                            <input type="text" id="first-name" required
                                class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Last Name</label>
                            <input type="text" id="last-name" required
                                class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Street Address</label>
                        <input type="text" id="street" required
                            class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Apt, Suite, etc. (optional)</label>
                        <input type="text" id="apt"
                            class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">City</label>
                            <input type="text" id="city" required
                                class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">State</label>
                            <input type="text" id="state" required
                                class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">ZIP Code</label>
                            <input type="text" id="zip" required
                                class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Country</label>
                            <select id="country"
                                class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                <option value="US">United States</option>
                                <option value="CA">Canada</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="is-default" class="w-4 h-4 text-amber-600 rounded">
                        <label for="is-default" class="text-sm text-slate-600">Set as default address</label>
                    </div>
                    <button type="submit"
                        class="w-full py-3 bg-amber-600 text-white font-bold rounded-lg hover:bg-amber-700 transition-colors cursor-pointer">
                        Save Address
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Cart Container -->
    <div id="cart-container"></div>

    <script src="../../js/app.js"></script>

    <script>
        let currentUserId = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) window.lucide.createIcons();

            window.handleSignOut = async function () {
                await window.authManager?.signOut();
                window.location.href = '../../index.html';
            };

            function updateSidebar(user) {
                const avatar = document.getElementById('sidebar-avatar');
                const name = document.getElementById('sidebar-name');
                const email = document.getElementById('sidebar-email');

                const displayName = user.displayName || user.email?.split('@')[0] || 'User';

                if (avatar) {
                    if (user.photoURL) {
                        avatar.innerHTML = `<img src="${user.photoURL}" class="w-full h-full rounded-full object-cover">`;
                    } else {
                        avatar.textContent = displayName[0].toUpperCase();
                    }
                }
                if (name) name.textContent = displayName;
                if (email) email.textContent = user.email;
            }

            window.showAddressModal = function (address = null) {
                const modal = document.getElementById('address-modal');
                const title = document.getElementById('modal-title');
                const form = document.getElementById('address-form');

                form.reset();
                document.getElementById('address-id').value = '';

                if (address) {
                    title.textContent = 'Edit Address';
                    document.getElementById('address-id').value = address.id;
                    document.getElementById('first-name').value = address.firstName || '';
                    document.getElementById('last-name').value = address.lastName || '';
                    document.getElementById('street').value = address.street || '';
                    document.getElementById('apt').value = address.apt || '';
                    document.getElementById('city').value = address.city || '';
                    document.getElementById('state').value = address.state || '';
                    document.getElementById('zip').value = address.zip || '';
                    document.getElementById('country').value = address.country || 'US';
                    document.getElementById('is-default').checked = address.isDefault || false;
                } else {
                    title.textContent = 'Add Address';
                }

                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            };

            window.hideAddressModal = function () {
                document.getElementById('address-modal').classList.add('hidden');
                document.body.style.overflow = '';
            };

            window.deleteAddress = async function (addressId) {
                if (!confirm('Are you sure you want to delete this address?')) return;

                const db = window.firebaseServices?.getFirestore();
                if (!db || !currentUserId) return;

                try {
                    await db.collection('users').doc(currentUserId).collection('addresses').doc(addressId).delete();
                    loadAddresses(currentUserId);
                } catch (error) {
                    console.error('Error deleting address:', error);
                }
            };

            // Handle form submit
            document.getElementById('address-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const db = window.firebaseServices?.getFirestore();
                if (!db || !currentUserId) return;

                const addressId = document.getElementById('address-id').value;
                const addressData = {
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    street: document.getElementById('street').value,
                    apt: document.getElementById('apt').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value,
                    country: document.getElementById('country').value,
                    isDefault: document.getElementById('is-default').checked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    const addressesRef = db.collection('users').doc(currentUserId).collection('addresses');

                    // If setting as default, unset other defaults
                    if (addressData.isDefault) {
                        const existing = await addressesRef.where('isDefault', '==', true).get();
                        const batch = db.batch();
                        existing.docs.forEach(doc => {
                            if (doc.id !== addressId) {
                                batch.update(doc.ref, { isDefault: false });
                            }
                        });
                        await batch.commit();
                    }

                    if (addressId) {
                        await addressesRef.doc(addressId).update(addressData);
                    } else {
                        addressData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await addressesRef.add(addressData);
                    }

                    hideAddressModal();
                    loadAddresses(currentUserId);
                } catch (error) {
                    console.error('Error saving address:', error);
                }
            });

            async function loadAddresses(userId) {
                const loadingState = document.getElementById('loading-state');
                const grid = document.getElementById('addresses-grid');
                const emptyState = document.getElementById('empty-state');

                const db = window.firebaseServices?.getFirestore();
                if (!db || !userId) {
                    loadingState.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                try {
                    const snapshot = await db
                        .collection('users')
                        .doc(userId)
                        .collection('addresses')
                        .orderBy('createdAt', 'desc')
                        .get();

                    loadingState.classList.add('hidden');

                    if (snapshot.empty) {
                        emptyState.classList.remove('hidden');
                        grid.classList.add('hidden');
                        return;
                    }

                    emptyState.classList.add('hidden');
                    grid.classList.remove('hidden');

                    grid.innerHTML = snapshot.docs.map(doc => {
                        const addr = { id: doc.id, ...doc.data() };
                        return `
                            <div class="bg-white rounded-xl border border-slate-100 p-6 relative ${addr.isDefault ? 'ring-2 ring-amber-500' : ''}">
                                ${addr.isDefault ? '<span class="absolute top-3 right-3 px-2 py-1 bg-amber-100 text-amber-700 text-xs font-bold rounded">Default</span>' : ''}
                                <p class="font-bold text-slate-900">${addr.firstName} ${addr.lastName}</p>
                                <p class="text-slate-600 mt-1">${addr.street}${addr.apt ? ', ' + addr.apt : ''}</p>
                                <p class="text-slate-600">${addr.city}, ${addr.state} ${addr.zip}</p>
                                <p class="text-slate-500 text-sm">${addr.country === 'US' ? 'United States' : 'Canada'}</p>
                                <div class="flex gap-3 mt-4 pt-4 border-t border-slate-100">
                                    <button onclick='showAddressModal(${JSON.stringify(addr).replace(/'/g, "&#39;")})'
                                        class="text-sm text-amber-600 hover:text-amber-700 font-medium cursor-pointer">Edit</button>
                                    <button onclick="deleteAddress('${addr.id}')"
                                        class="text-sm text-red-600 hover:text-red-700 font-medium cursor-pointer">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('Error loading addresses:', error);
                    loadingState.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                }
            }

            // Subscribe to auth changes
            if (window.authManager) {
                window.authManager.subscribe((event, user) => {
                    if (event === 'authStateChanged') {
                        if (user) {
                            currentUserId = user.uid;
                            updateSidebar(user);
                            loadAddresses(user.uid);
                        } else {
                            window.location.href = 'index.html';
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>