<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | Apex Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../css/design-system.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../../js/cart.js" defer></script>
    <script src="../../js/firebase-init.js" defer></script>
    <script src="../../js/auth.js" defer></script>
</head>

<body class="bg-gray-50 antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-100 sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <a href="../../index.html" class="flex items-center gap-2">
                    <span class="text-xl font-black text-slate-900 tracking-tight">APEX LABS</span>
                </a>
                <div class="flex items-center gap-4">
                    <a href="../../peptides.html" class="text-sm font-medium text-slate-600 hover:text-slate-900">Shop</a>
                    <button onclick="toggleCart()" class="relative p-2 hover:bg-slate-100 rounded-lg transition-colors cursor-pointer">
                        <i data-lucide="shopping-bag" class="w-5 h-5 text-slate-600"></i>
                        <span id="cart-count" class="absolute -top-1 -right-1 w-5 h-5 bg-amber-500 text-white text-xs font-bold rounded-full flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-6 py-12">
        <div class="grid lg:grid-cols-12 gap-8">
            <!-- Sidebar -->
            <aside class="lg:col-span-3">
                <div class="bg-white rounded-xl border border-slate-100 p-6 sticky top-24">
                    <!-- User Info -->
                    <div class="flex items-center gap-4 mb-6 pb-6 border-b border-slate-100">
                        <div id="sidebar-avatar" class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center text-white font-bold text-lg"></div>
                        <div>
                            <p id="sidebar-name" class="font-bold text-slate-900">Loading...</p>
                            <p id="sidebar-email" class="text-sm text-slate-500 truncate max-w-[150px]"></p>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <nav class="space-y-1">
                        <a href="index.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-amber-50 text-amber-700 font-medium">
                            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                            Dashboard
                        </a>
                        <a href="orders.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
                            <i data-lucide="package" class="w-5 h-5"></i>
                            Orders
                        </a>
                        <a href="wishlist.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
                            <i data-lucide="heart" class="w-5 h-5"></i>
                            Wishlist
                        </a>
                        <a href="addresses.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            Addresses
                        </a>
                    </nav>

                    <!-- Sign Out -->
                    <button onclick="handleSignOut()" class="w-full mt-6 pt-6 border-t border-slate-100 flex items-center gap-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors cursor-pointer">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        Sign Out
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="lg:col-span-9">
                <!-- Loading State -->
                <div id="loading-state" class="text-center py-12">
                    <div class="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
                    <p class="text-slate-500 mt-4">Loading your account...</p>
                </div>

                <!-- Not Logged In State -->
                <div id="login-prompt" class="hidden text-center py-16 bg-white rounded-xl border border-slate-100">
                    <i data-lucide="user-circle" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">Sign In Required</h2>
                    <p class="text-slate-500 mb-6">Please sign in to access your account.</p>
                    <button onclick="openAuthModal()" class="px-8 py-3 bg-amber-600 text-white font-bold rounded-xl hover:bg-amber-700 transition-colors cursor-pointer">
                        Sign In
                    </button>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboard-content" class="hidden space-y-8">
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-amber-500 to-amber-600 rounded-xl p-8 text-white">
                        <h1 class="text-3xl font-bold mb-2">Welcome back, <span id="welcome-name">User</span></h1>
                        <p class="text-amber-100">Manage your orders, wishlist, and account settings.</p>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid sm:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl p-6 border border-slate-100">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center">
                                    <i data-lucide="package" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div>
                                    <p id="total-orders" class="text-2xl font-bold text-slate-900">0</p>
                                    <p class="text-sm text-slate-500">Total Orders</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 border border-slate-100">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-pink-50 flex items-center justify-center">
                                    <i data-lucide="heart" class="w-6 h-6 text-pink-600"></i>
                                </div>
                                <div>
                                    <p id="wishlist-count" class="text-2xl font-bold text-slate-900">0</p>
                                    <p class="text-sm text-slate-500">Wishlist Items</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 border border-slate-100">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center">
                                    <i data-lucide="map-pin" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div>
                                    <p id="address-count" class="text-2xl font-bold text-slate-900">0</p>
                                    <p class="text-sm text-slate-500">Saved Addresses</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div class="bg-white rounded-xl border border-slate-100">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <h2 class="text-lg font-bold text-slate-900">Recent Orders</h2>
                            <a href="orders.html" class="text-sm text-amber-600 hover:text-amber-700 font-medium">View All</a>
                        </div>
                        <div id="recent-orders" class="p-6">
                            <div class="text-center py-8 text-slate-400">
                                <i data-lucide="inbox" class="w-10 h-10 mx-auto mb-3 opacity-50"></i>
                                <p>No orders yet</p>
                                <a href="../../peptides.html" class="text-amber-600 hover:text-amber-700 text-sm font-medium mt-2 inline-block">Start Shopping</a>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid sm:grid-cols-2 gap-4">
                        <a href="../../peptides.html" class="flex items-center gap-4 p-6 bg-white rounded-xl border border-slate-100 hover:border-amber-200 hover:shadow-md transition-all group">
                            <div class="w-12 h-12 rounded-full bg-amber-50 flex items-center justify-center group-hover:bg-amber-100 transition-colors">
                                <i data-lucide="shopping-bag" class="w-6 h-6 text-amber-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900">Continue Shopping</h3>
                                <p class="text-sm text-slate-500">Browse our peptide collection</p>
                            </div>
                        </a>
                        <a href="wishlist.html" class="flex items-center gap-4 p-6 bg-white rounded-xl border border-slate-100 hover:border-pink-200 hover:shadow-md transition-all group">
                            <div class="w-12 h-12 rounded-full bg-pink-50 flex items-center justify-center group-hover:bg-pink-100 transition-colors">
                                <i data-lucide="heart" class="w-6 h-6 text-pink-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900">View Wishlist</h3>
                                <p class="text-sm text-slate-500">Items you've saved for later</p>
                            </div>
                        </a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Auth Modal Container -->
    <div id="auth-modal-container"></div>

    <!-- Cart Container -->
    <div id="cart-container"></div>

    <script src="../../js/app.js"></script>
    <script src="../../js/wishlist.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) window.lucide.createIcons();

            const loadingState = document.getElementById('loading-state');
            const loginPrompt = document.getElementById('login-prompt');
            const dashboardContent = document.getElementById('dashboard-content');

            // Handle sign out
            window.handleSignOut = async function() {
                try {
                    await window.authManager.signOut();
                    window.location.href = '../../index.html';
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            };

            // Update UI for authenticated user
            function showDashboard(user) {
                loadingState.classList.add('hidden');
                loginPrompt.classList.add('hidden');
                dashboardContent.classList.remove('hidden');

                // Update sidebar
                const avatar = document.getElementById('sidebar-avatar');
                const name = document.getElementById('sidebar-name');
                const email = document.getElementById('sidebar-email');
                const welcomeName = document.getElementById('welcome-name');

                const displayName = user.displayName || user.email?.split('@')[0] || 'User';

                if (avatar) {
                    if (user.photoURL) {
                        avatar.innerHTML = `<img src="${user.photoURL}" class="w-full h-full rounded-full object-cover">`;
                    } else {
                        avatar.textContent = displayName[0].toUpperCase();
                    }
                }
                if (name) name.textContent = displayName;
                if (email) email.textContent = user.email;
                if (welcomeName) welcomeName.textContent = displayName.split(' ')[0];

                // Load stats
                loadUserStats(user.uid);
            }

            // Show login prompt
            function showLoginPrompt() {
                loadingState.classList.add('hidden');
                loginPrompt.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
            }

            // Load user statistics
            async function loadUserStats(userId) {
                // Get wishlist count
                if (window.wishlistManager) {
                    document.getElementById('wishlist-count').textContent = window.wishlistManager.getCount();

                    window.wishlistManager.subscribe((event, items) => {
                        const count = Array.isArray(items) ? items.length : window.wishlistManager.getCount();
                        document.getElementById('wishlist-count').textContent = count;
                    });
                }

                // Get orders from Firestore
                const db = window.firebaseServices?.getFirestore();
                if (db && userId) {
                    try {
                        const ordersSnapshot = await db
                            .collection('users')
                            .doc(userId)
                            .collection('orders')
                            .orderBy('createdAt', 'desc')
                            .limit(5)
                            .get();

                        document.getElementById('total-orders').textContent = ordersSnapshot.size;

                        // Display recent orders
                        if (!ordersSnapshot.empty) {
                            const recentOrdersEl = document.getElementById('recent-orders');
                            recentOrdersEl.innerHTML = ordersSnapshot.docs.map(doc => {
                                const order = doc.data();
                                return `
                                    <div class="flex items-center justify-between py-4 border-b border-slate-50 last:border-0">
                                        <div>
                                            <p class="font-medium text-slate-900">Order #${doc.id.slice(-8).toUpperCase()}</p>
                                            <p class="text-sm text-slate-500">${order.status || 'Processing'}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-slate-900">$${(order.amountTotal || 0).toFixed(2)}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }

                        // Get addresses count
                        const addressesSnapshot = await db
                            .collection('users')
                            .doc(userId)
                            .collection('addresses')
                            .get();

                        document.getElementById('address-count').textContent = addressesSnapshot.size;
                    } catch (error) {
                        console.error('Error loading stats:', error);
                    }
                }
            }

            // Subscribe to auth changes
            if (window.authManager) {
                window.authManager.subscribe((event, user) => {
                    if (event === 'authStateChanged') {
                        if (user) {
                            showDashboard(user);
                        } else {
                            showLoginPrompt();
                        }
                    }
                });
            } else {
                // Auth manager not loaded, show login
                setTimeout(() => showLoginPrompt(), 1000);
            }

            // Load auth modal
            fetch('../../components/auth-modal.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('auth-modal-container').innerHTML = html;
                })
                .catch(console.error);
        });
    </script>
</body>

</html>
